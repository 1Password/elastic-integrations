---
description: Pipeline for normalizing 1Password Item Usage Events
processors:
  - rename:
      field: message
      target_field: event.original
  - json:
      field: event.original
      target_field: onepassword
  - drop:
      description: Drop if no timestamp (invalid json)
      if: "ctx?.onepassword?.timestamp == null"

  #######################
  ## ECS Event Mapping ##
  #######################
  - set:
      field: event.ingested
      value: "{{_ingest.timestamp}}"
  # Sets event.created from the @timestamp field generated by filebeat before being overwritten further down
  - set:
      field: event.created
      copy_from: "@timestamp"

  ######################
  ## ECS User Mapping ##
  ######################
  - rename:
      field: onepassword.user.uuid
      target_field: user.id
      ignore_missing: true
  - rename:
      field: onepassword.user.name
      target_field: user.full_name
      ignore_missing: true
  - rename:
      field: onepassword.user.email
      target_field: user.email
      ignore_missing: true

  ####################
  ## ECS OS Mapping ##
  ####################
  - rename:
      field: onepassword.client.os_name
      target_field: os.name
      ignore_missing: true
  - rename:
      field: onepassword.client.os_version
      target_field: os.version
      ignore_missing: true

  ########################
  ## ECS Source Mapping ##
  ########################
  - rename:
      field: onepassword.client.ip_address
      target_field: source.ip
      ignore_missing: true
  - geoip:
      field: source.ip
      target_field: source.geo
  - geoip:
      database_file: GeoLite2-ASN.mmdb
      field: source.ip
      target_field: source.as
      properties:
        - asn
        - organization_name
      ignore_missing: true
  - rename:
      field: source.as.asn
      target_field: source.as.number
      ignore_missing: true
  - rename:
      field: source.as.organization_name
      target_field: source.as.organization.name
      ignore_missing: true

  ######################
  ## ECS Base Mapping ##
  ######################
  - date:
      field: onepassword.timestamp
      formats:
        - ISO8601
  - remove:
      field: onepassword.timestamp

  #############
  ## Cleanup ##
  #############
  - remove:
      field: onepassword.user
  - remove:
      field: event.original
      if: "ctx?.tags == null || !(ctx.tags.contains('preserve_original_event'))"
      ignore_failure: true
      ignore_missing: true
on_failure:
  - set:
      field: error.message
      value: "{{ _ingest.on_failure_message }}"
